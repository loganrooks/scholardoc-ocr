# Requirements Archive: v2.1 Performance

**Archived:** 2026-02-04
**Status:** SHIPPED

This is the archived requirements specification for v2.1.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

## v2.1 Requirements

Requirements for v2.1 Performance milestone â€” Surya optimization for Apple Silicon.

### Device Configuration

- [x] **DEV-01**: Pipeline explicitly selects MPS device on Apple Silicon
- [x] **DEV-02**: Device availability validated at startup with actionable error messages
- [x] **DEV-03**: Automatic fallback to CPU when MPS unavailable or fails
- [x] **DEV-04**: Per-model device selection (detection on CPU, recognition on MPS) to work around MPS bugs

### Batch Optimization

- [x] **BATCH-01**: Batch size configuration passed to Surya converter
- [x] **BATCH-02**: Surya environment variables set for batch tuning (RECOGNITION_BATCH_SIZE, DETECTOR_BATCH_SIZE, etc.)
- [x] **BATCH-03**: Hardware-aware batch size defaults based on available memory
- [x] **BATCH-04**: Cross-file page batching aggregates flagged pages across all files into single Surya call
- [x] **BATCH-05**: Adaptive batch sizing adjusts based on actual memory pressure

### Model Management

- [x] **MODEL-01**: Model caching persists loaded models across MCP requests
- [x] **MODEL-02**: TTL-based cache eviction prevents memory bloat
- [x] **MODEL-03**: Memory cleanup between documents (torch.mps.empty_cache + gc.collect)
- [x] **MODEL-04**: Warm model pool pre-loads models on MCP server startup
- [x] **MODEL-05**: Memory profiling integration tracks VRAM usage during processing

### Benchmarking & Metrics

- [x] **BENCH-01**: Baseline performance measurement infrastructure with pytest-benchmark
- [x] **BENCH-02**: Correct timing methodology using torch.mps.synchronize()
- [x] **BENCH-03**: Regression detection integrated into CI pipeline
- [x] **BENCH-04**: Memory profiling with memray for leak detection
- [x] **BENCH-05**: Hardware-specific benchmark profiles for M1/M2/M3 variants
- [x] **BENCH-06**: Surya processing time captured in phase_timings (model load + inference)
- [x] **BENCH-07**: Top-level engine field reflects actual processing (mixed/tesseract/surya)
- [x] **BENCH-08**: Quality scores re-evaluated after Surya processing

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| DEV-01 | Phase 12 | Complete |
| DEV-02 | Phase 12 | Complete |
| DEV-03 | Phase 12 | Complete |
| DEV-04 | Phase 12 | Complete |
| BATCH-01 | Phase 14 | Complete |
| BATCH-02 | Phase 14 | Complete |
| BATCH-03 | Phase 14 | Complete |
| BATCH-04 | Phase 14 | Complete |
| BATCH-05 | Phase 14 | Complete |
| MODEL-01 | Phase 13 | Complete |
| MODEL-02 | Phase 13 | Complete |
| MODEL-03 | Phase 13 | Complete |
| MODEL-04 | Phase 13 | Complete |
| MODEL-05 | Phase 13 | Complete |
| BENCH-01 | Phase 11 | Complete |
| BENCH-02 | Phase 11 | Complete |
| BENCH-03 | Phase 11 | Complete |
| BENCH-04 | Phase 11 | Complete |
| BENCH-05 | Phase 11 | Complete |
| BENCH-06 | Phase 11 | Complete |
| BENCH-07 | Phase 11 | Complete |
| BENCH-08 | Phase 11 | Complete |

**Coverage:**
- v2.1 requirements: 22 total
- Mapped to phases: 22
- Complete: 22/22

---

## Milestone Summary

**Shipped:** 22 of 22 v2.1 requirements
**Adjusted:** None
**Dropped:** None

---
*Archived: 2026-02-04 as part of v2.1 milestone completion*
