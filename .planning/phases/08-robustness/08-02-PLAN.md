---
phase: 08-robustness
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scholardoc_ocr/environment.py
autonomous: true

must_haves:
  truths:
    - "User gets a clear error at startup when tesseract binary is missing"
    - "User gets a clear error when required language packs are missing"
    - "Startup diagnostic log shows tesseract version, available langs, TMPDIR, Python version"
  artifacts:
    - path: "src/scholardoc_ocr/environment.py"
      provides: "validate_environment() and startup_diagnostics()"
      contains: "validate_environment"
  key_links:
    - from: "src/scholardoc_ocr/environment.py"
      to: "shutil.which"
      via: "stdlib import"
      pattern: "shutil.which"
---

<objective>
Create the environment validation module that checks for tesseract binary, required language packs, and writable TMPDIR before pipeline dispatch, plus a startup diagnostics reporter.

Purpose: ROBU-02 and ROBU-08 — users must get clear errors for missing dependencies at startup rather than cryptic failures mid-processing, and diagnostic info must be logged for support/debugging.
Output: `src/scholardoc_ocr/environment.py` with public API for CLI/pipeline integration.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-robustness/08-RESEARCH.md
@src/scholardoc_ocr/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment.py with validation and diagnostics</name>
  <files>src/scholardoc_ocr/environment.py</files>
  <action>
Create `src/scholardoc_ocr/environment.py` with:

1. `class EnvironmentError(RuntimeError):` — custom exception for environment problems, with a `problems: list[str]` attribute listing all detected issues.

2. `validate_environment(langs_tesseract: str = "eng,fra,ell,lat,deu") -> None`
   - Uses `shutil.which("tesseract")` to find the binary. If missing, record problem: "tesseract not found on PATH. Install: brew install tesseract (macOS) or apt install tesseract-ocr (Linux)"
   - If tesseract found, run `subprocess.run(["tesseract", "--list-langs"], capture_output=True, text=True)` to get available languages
   - Parse the output (skip first line "List of available languages"), compare against required langs from `langs_tesseract.split(",")`. For each missing lang, record problem: "tesseract language pack '{lang}' not installed. Install: brew install tesseract-lang (macOS) or apt install tesseract-ocr-{lang} (Linux)"
   - Check TMPDIR is writable: `tempfile.gettempdir()` then try creating and removing a temp file there. If fails, record problem: "TMPDIR ({path}) is not writable"
   - If any problems recorded, raise `EnvironmentError` with all problems joined by newlines

3. `log_startup_diagnostics(langs_tesseract: str = "eng,fra,ell,lat,deu") -> None`
   - Logs at INFO level:
     - Python version: `sys.version`
     - Platform: `platform.platform()`
     - tesseract version: run `tesseract --version`, parse first line
     - tesseract available langs: from `--list-langs`
     - TMPDIR: `tempfile.gettempdir()`
     - Requested languages: the langs_tesseract string
   - Uses `logger = logging.getLogger(__name__)`
   - Does NOT raise on errors — logs warnings for any issues but continues
  </action>
  <verify>
    `python -c "from scholardoc_ocr.environment import validate_environment, log_startup_diagnostics; print('OK')"`
  </verify>
  <done>Module imports cleanly, validate_environment raises EnvironmentError with clear messages for missing deps, log_startup_diagnostics logs system info.</done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for environment validation</name>
  <files>tests/test_environment.py</files>
  <action>
Create `tests/test_environment.py` with tests:

1. `test_validate_environment_passes_when_tesseract_available` — on a system with tesseract installed, `validate_environment()` should not raise. Skip with `@pytest.mark.skipif(shutil.which("tesseract") is None, reason="tesseract not installed")`.

2. `test_validate_environment_raises_when_tesseract_missing` — mock `shutil.which` to return None, verify `EnvironmentError` is raised with "tesseract not found" in the message.

3. `test_validate_environment_raises_for_missing_lang` — mock `shutil.which` to return "/usr/bin/tesseract", mock `subprocess.run` to return only "eng" in --list-langs output, call with langs requiring "fra", verify EnvironmentError mentions "fra".

4. `test_log_startup_diagnostics_no_crash` — call `log_startup_diagnostics()` with caplog, verify it logs something (don't assert specific content since tesseract may or may not be installed).

5. `test_environment_error_has_problems_list` — create `EnvironmentError` manually, verify `.problems` attribute is a list.

Use `pytest`, `unittest.mock.patch`, `tmp_path` fixture.
  </action>
  <verify>`pytest tests/test_environment.py -v`</verify>
  <done>All 5 tests pass, confirming environment validation catches missing tesseract and language packs.</done>
</task>

</tasks>

<verification>
- `ruff check src/scholardoc_ocr/environment.py` passes
- `pytest tests/test_environment.py -v` — all tests pass
</verification>

<success_criteria>
- environment.py exists with validate_environment and log_startup_diagnostics
- Missing tesseract produces clear actionable error message
- Missing language packs produce clear error with install instructions
- Startup diagnostics logged at INFO level
</success_criteria>

<output>
After completion, create `.planning/phases/08-robustness/08-02-SUMMARY.md`
</output>
