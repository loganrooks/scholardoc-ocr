---
phase: 16-test-corpus-ground-truth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/corpus/.gitignore
  - tests/corpus/corpus.json
  - scripts/corpus/render_pages.py
  - scripts/corpus/build_coverage_matrix.py
autonomous: true

must_haves:
  truths:
    - "tests/corpus/ directory structure exists with subdirectories for pdfs, ground_truth, baselines, and images"
    - "corpus.json manifest describes 4 philosophy documents with observable metadata and pipeline version pinning"
    - ".gitignore prevents PDFs, rendered images, and baseline PDF binaries from being committed while allowing manifest, ground truth text, and diagnostic JSON"
    - "Helper scripts can render specific PDF pages as PNGs and analyze diagnostic baselines for coverage matrix"
  artifacts:
    - path: "tests/corpus/.gitignore"
      provides: "Corpus-local gitignore rules"
      contains: "pdfs/"
    - path: "tests/corpus/corpus.json"
      provides: "Manifest with 4 document entries"
      contains: "simondon-technical-objects"
    - path: "scripts/corpus/render_pages.py"
      provides: "Page rendering utility for Opus transcription"
      contains: "get_pixmap"
    - path: "scripts/corpus/build_coverage_matrix.py"
      provides: "Coverage matrix analysis from diagnostic baselines"
      contains: "struggle_categories"
  key_links:
    - from: "scripts/corpus/render_pages.py"
      to: "tests/corpus/corpus.json"
      via: "reads manifest to locate PDF symlinks"
      pattern: "corpus.json"
    - from: "scripts/corpus/build_coverage_matrix.py"
      to: "tests/corpus/baselines/**/final/*.diagnostics.json"
      via: "parses diagnostic sidecar JSON from Phase 15"
      pattern: "struggle_categories"
---

<objective>
Create the corpus directory structure, manifest, and helper scripts for the evaluation corpus.

Purpose: Establish the infrastructure that CORP-02 through CORP-04 build upon. The manifest schema, directory layout, and gitignore rules must be correct before any documents are registered or baselines captured.

Output: tests/corpus/ directory with manifest skeleton and .gitignore; scripts/corpus/ with page rendering and coverage matrix analysis utilities.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-test-corpus-ground-truth/16-CONTEXT.md
@.planning/phases/16-test-corpus-ground-truth/16-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create corpus directory structure, .gitignore, and manifest</name>
  <files>
    tests/corpus/.gitignore
    tests/corpus/corpus.json
  </files>
  <action>
Create the following directory structure:
```
tests/corpus/
  corpus.json
  .gitignore
  pdfs/           (empty, will hold PDF symlinks)
  ground_truth/   (empty, will hold per-document subdirectories)
  baselines/      (empty, will hold per-document baseline output)
  images/         (empty, will hold rendered page PNGs)
```

Create `tests/corpus/.gitignore` with these rules:
```gitignore
# PDF files (large binaries, user-specific paths)
pdfs/

# Rendered page images (regenerable from PDFs)
images/

# Pipeline output PDFs (large binaries)
baselines/**/final/*.pdf

# Pipeline work directories and logs
baselines/**/work/
baselines/**/logs/
```

Create `tests/corpus/corpus.json` manifest with the schema from RESEARCH.md. Key requirements:
- `version`: "1.0"
- `created`: current date
- `pipeline_versions`: record current versions (scholardoc_ocr 0.2.0, tesseract 5.5.2, surya_ocr 0.17.1, marker_pdf 1.10.2, ocrmypdf 16.13.0, pymupdf 1.26.7)
- `documents` array with 4 entries:
  1. `simondon-technical-objects`: title "Du mode d'existence des objets techniques", author "Gilbert Simondon", language ["fr"], has_footnotes true, has_greek false, has_toc true
  2. `derrida-grammatology`: title "Of Grammatology", author "Jacques Derrida", language ["en"], has_footnotes true, has_greek true, has_toc true
  3. `derrida-margins`: title "Margins of Philosophy", author "Jacques Derrida", language ["en"], has_footnotes true, has_greek true, has_toc true
  4. `derrida-dissemination`: title "Dissemination", author "Jacques Derrida", language ["en"], has_footnotes true, has_greek true, has_toc true
- Each document has: `page_count: null`, `scan_source: null`, `baseline` object with path/diagnostics_file/text_file/run_date/pipeline_version (all paths relative to tests/corpus/), `diagnostic_summary: null`, `ground_truth_pages: {}`
- Use the exact JSON schema from RESEARCH.md Code Examples section

IMPORTANT: All page numbers throughout the corpus are 0-indexed, matching `PageResult.page_number` convention in the codebase.
  </action>
  <verify>
- `ls -la tests/corpus/` shows corpus.json, .gitignore, and subdirectories (pdfs, ground_truth, baselines, images)
- `python -m json.tool tests/corpus/corpus.json` validates JSON syntax
- `cat tests/corpus/.gitignore` shows pdfs/, images/, and baselines PDF rules
- `cd tests/corpus && git check-ignore pdfs/test.pdf` confirms PDFs are ignored
- `cd tests/corpus && git check-ignore baselines/doc/final/doc.pdf` confirms baseline PDFs are ignored
- `cd tests/corpus && git check-ignore baselines/doc/final/doc.diagnostics.json; echo $?` returns 1 (NOT ignored)
  </verify>
  <done>
tests/corpus/ directory structure exists. corpus.json is valid JSON describing 4 philosophy documents with observable metadata. .gitignore prevents PDFs and images from being committed while allowing diagnostic JSON and ground truth text.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create helper scripts for page rendering and coverage matrix analysis</name>
  <files>
    scripts/corpus/render_pages.py
    scripts/corpus/build_coverage_matrix.py
  </files>
  <action>
Create `scripts/corpus/render_pages.py` based on RESEARCH.md Pattern 3, with these requirements:
- CLI interface: `python scripts/corpus/render_pages.py <document-id> <page_numbers...>`
- Reads corpus.json manifest to find PDF symlink path
- Renders specified pages at 300 DPI using `fitz.Page.get_pixmap(dpi=300).save()`
- Outputs to `tests/corpus/images/{document-id}/page_{NNN:03d}.png`
- Creates output directory if it does not exist
- Page numbers are 0-indexed (matching PageResult convention)
- Validates page numbers are within document range
- Prints rendered file paths for confirmation
- Add `--all-selected` flag that reads `ground_truth_pages` from manifest and renders all pages listed there (useful after page selection is done)
- IMPORTANT: corpus_dir defaults to `tests/corpus` (relative to project root, script is run from project root)

Create `scripts/corpus/build_coverage_matrix.py` based on RESEARCH.md Pattern 4, with these requirements:
- CLI interface: `python scripts/corpus/build_coverage_matrix.py`
- Reads all .diagnostics.json files referenced in corpus.json manifest
- For each document, builds per-page breakdown of:
  - Struggle categories (from `diagnostics.struggle_categories` array)
  - Gray zone pages (where `gray_zone` is in struggle_categories)
  - Signal disagreement pages (from `diagnostics.has_signal_disagreement`)
  - Quality scores (from page-level `quality_score`)
- Outputs a human-readable coverage report showing:
  - Per-category page counts with example pages (doc_id + page_number)
  - Gray zone and signal disagreement totals
  - Recommended "difficult" page selection: at least 2 pages per category (up to 3 if from different documents), all gray_zone pages, all signal_disagreement pages
  - Recommended "regression" page selection: per document, 1 ToC page, 1 front matter page, 2-3 clean body text pages (quality_score > 0.90, no struggle categories), 1 bibliography page if present
  - Total recommended pages and per-document breakdown
- Also outputs a JSON file `tests/corpus/page_selection.json` with the recommended selection for machine consumption:
  ```json
  {
    "difficult": {"doc-id": [0, 5, 42, ...], ...},
    "regression": {"doc-id": [0, 1, 200, ...], ...},
    "total_pages": 67,
    "coverage_summary": {"category": count, ...}
  }
  ```
- IMPORTANT: Page numbers are 0-indexed throughout. The script parses `page["page_number"]` from the diagnostic sidecar.

Both scripts should:
- Use `#!/usr/bin/env python3` shebang
- Have a docstring explaining usage
- Handle missing files gracefully with clear error messages
- Use `pathlib.Path` for all path operations
- Be runnable from the project root directory
  </action>
  <verify>
- `python scripts/corpus/render_pages.py --help` or running with no args shows usage
- `python scripts/corpus/build_coverage_matrix.py` runs without error (will report "no baselines found" if none exist yet, but should not crash)
- `ruff check scripts/corpus/` passes lint
- Both scripts have proper shebang and docstring
  </verify>
  <done>
Two helper scripts exist: render_pages.py renders PDF pages as 300 DPI PNGs for Opus transcription, build_coverage_matrix.py analyzes diagnostic baselines to produce a coverage matrix and page selection recommendation. Both handle missing data gracefully and use 0-indexed page numbers.
  </done>
</task>

</tasks>

<verification>
1. `tests/corpus/corpus.json` is valid JSON with 4 document entries matching the required schema
2. `tests/corpus/.gitignore` correctly ignores PDFs and images while allowing diagnostic JSON and ground truth text
3. Directory structure has pdfs/, ground_truth/, baselines/, images/ subdirectories
4. `scripts/corpus/render_pages.py` can be invoked without errors (even if no PDFs exist yet)
5. `scripts/corpus/build_coverage_matrix.py` can be invoked and reports "no baselines" gracefully
6. `ruff check scripts/corpus/` passes lint
</verification>

<success_criteria>
- Corpus directory structure is ready for document registration and baseline capture
- Manifest schema supports the full workflow: document metadata -> baseline -> page selection -> ground truth
- Helper scripts are functional and ready for use after baselines are captured
- All file paths use 0-indexed page numbers consistently
</success_criteria>

<output>
After completion, create `.planning/phases/16-test-corpus-ground-truth/16-01-SUMMARY.md`
</output>
