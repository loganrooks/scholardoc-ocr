---
phase: 16-test-corpus-ground-truth
plan: 03
type: execute
wave: 3
depends_on: ["16-02"]
files_modified:
  - tests/corpus/corpus.json
  - tests/corpus/ground_truth/
autonomous: false

must_haves:
  truths:
    - "Ground truth text files exist for all selected pages (60-70 target, coverage-driven count)"
    - "Each ground truth file is a faithful UTF-8 NFC-normalized transcription with proper paragraph structure and footnote separation"
    - "Manifest ground_truth_pages mappings correctly link page numbers to ground truth file paths"
    - "Human spot-check of 10-15% sample confirms ground truth quality"
  artifacts:
    - path: "tests/corpus/ground_truth/simondon-technical-objects/"
      provides: "Ground truth text files for Simondon selected pages"
    - path: "tests/corpus/ground_truth/derrida-grammatology/"
      provides: "Ground truth text files for Derrida Grammatology selected pages"
    - path: "tests/corpus/ground_truth/derrida-margins/"
      provides: "Ground truth text files for Derrida Margins selected pages"
    - path: "tests/corpus/ground_truth/derrida-dissemination/"
      provides: "Ground truth text files for Derrida Dissemination selected pages"
    - path: "tests/corpus/corpus.json"
      provides: "Finalized manifest with ground_truth_pages mappings for all documents"
      contains: "ground_truth_pages"
  key_links:
    - from: "tests/corpus/corpus.json"
      to: "tests/corpus/ground_truth/{doc-id}/page_NNN.txt"
      via: "ground_truth_pages mapping keys match actual file paths"
      pattern: "ground_truth/"
    - from: "tests/corpus/ground_truth/"
      to: "tests/corpus/images/"
      via: "ground truth transcribed from rendered page images"
---

<objective>
Create ground truth text files for all selected pages via Opus vision transcription and finalize the corpus manifest.

Purpose: Ground truth text is the reference standard for Phases 17-19 evaluation. Without faithful transcriptions, CER/WER metrics and LLM evaluation are meaningless. This plan produces the aligned (OCR output, ground truth) pairs that the entire v3.0 milestone depends on.

Output: Ground truth text files in tests/corpus/ground_truth/{doc-id}/, finalized corpus.json with complete ground_truth_pages mappings.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary-standard.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-test-corpus-ground-truth/16-CONTEXT.md
@.planning/phases/16-test-corpus-ground-truth/16-RESEARCH.md
@.planning/phases/16-test-corpus-ground-truth/16-02-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create ground truth transcriptions via Opus vision</name>
  <action>
The user creates ground truth text files by feeding the rendered page PNGs to Claude Opus for transcription. This is a manual process because it requires visual interpretation of scanned page images.

**Transcription workflow:**

For each selected page (from `tests/corpus/page_selection.json`):

1. Open the rendered PNG from `tests/corpus/images/{doc-id}/page_{NNN:03d}.png`
2. Send the image to Claude Opus with this transcription prompt:

```
Transcribe the text on this scanned page faithfully. Follow these rules exactly:

- Preserve proper Unicode characters (Greek, Latin, diacritics)
- Use NFC Unicode normalization
- Separate paragraphs with blank lines
- Separate footnotes from body text with a line containing only "---"
- Number footnotes to match the source
- EXCLUDE: page numbers, running headers/footers, marginal annotations
- For multi-column layout: transcribe left column first, then right
- For tables: use plain text with consistent spacing (not markdown tables)
- For equations: best-effort plain text transcription
- Preserve the original language (do not translate)

Output ONLY the transcribed text, no commentary.
```

3. Save the transcription as `tests/corpus/ground_truth/{doc-id}/page_{NNN:03d}.txt`
   - UTF-8 encoding, Unix LF line endings
   - File name uses 0-indexed page number with 3-digit zero-padding

**Efficient batching:**

Process pages in batches by document. For each document:
1. Open all selected page PNGs in order
2. Transcribe each, saving to the correct filename
3. Quick sanity check: each file should have content (not empty), reasonable length

**Expected volume:** ~60-70 pages total across 4 documents. At ~1-2 minutes per page for Opus transcription, expect 1-2 hours total.

**Create ground truth directories first:**
```bash
mkdir -p tests/corpus/ground_truth/simondon-technical-objects
mkdir -p tests/corpus/ground_truth/derrida-grammatology
mkdir -p tests/corpus/ground_truth/derrida-margins
mkdir -p tests/corpus/ground_truth/derrida-dissemination
```

**Spot-check (10-15% sample):**

After all transcriptions are done, manually verify ~7-10 pages (spread across documents and difficulty levels):
- Compare transcription against the page image
- Check for: missing text, wrong characters, diacritics errors, paragraph structure issues
- Pay special attention to: Greek characters, French accents, footnote numbering
- If systematic errors found (e.g., Opus consistently misreads a ligature), run a targeted correction pass on all affected files
  </action>
  <resume-signal>Type "ground truth complete" when all transcriptions are saved and spot-check is done. Report any systematic issues found during spot-check, or "spot-check clean" if no issues.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Finalize manifest with ground truth mappings and verify corpus completeness</name>
  <files>
    tests/corpus/corpus.json
  </files>
  <action>
After the user confirms ground truth is complete, perform these steps:

**Step 1: Scan ground truth files and build mappings**

For each document in the manifest, scan `tests/corpus/ground_truth/{doc-id}/` to find all `page_NNN.txt` files. Build the `ground_truth_pages` mapping in corpus.json:

```json
"ground_truth_pages": {
    "42": "ground_truth/simondon-technical-objects/page_042.txt",
    "73": "ground_truth/simondon-technical-objects/page_073.txt"
}
```

Note: JSON keys must be strings, so page numbers are string-encoded. The values are paths relative to `tests/corpus/`.

**Step 2: Validate ground truth files**

For each ground truth file:
- Verify it exists and is non-empty
- Verify it is valid UTF-8
- Check that it is NFC-normalized (run `unicodedata.normalize("NFC", text)` and compare -- should be identical)
- Report any files that fail validation

**Step 3: Cross-reference with page selection**

Verify that every page in `page_selection.json` (both difficult and regression) has a corresponding ground truth file. Report any missing pages.

**Step 4: Update manifest metadata**

- Set `corpus.json` `version` to "1.0" (already set)
- Update `created` date if needed
- Ensure all document entries have populated: `page_count`, `diagnostic_summary`, `selected_pages`, `ground_truth_pages`, `baseline` (run_date and pipeline_version)
- Verify no null placeholders remain except where genuinely unknown (e.g., `scan_source` if user didn't specify)

**Step 5: Corpus completeness summary**

Print a summary of the finalized corpus:
- Total documents: 4
- Total pages across documents
- Total ground truth pages (difficult + regression)
- Per-document breakdown: pages, ground truth count, struggle categories covered
- Any gaps or warnings
  </action>
  <verify>
- `python -m json.tool tests/corpus/corpus.json` validates JSON
- Every page listed in `ground_truth_pages` for each document has a corresponding .txt file that exists and is non-empty
- Every page in `page_selection.json` has a corresponding ground truth file
- No remaining null values in manifest except `scan_source` fields (if user didn't provide)
- `git status tests/corpus/ground_truth/` shows the ground truth files as untracked (ready to commit)
- `git status tests/corpus/baselines/` shows diagnostic JSON and txt files as untracked (ready to commit)
- Ground truth files do NOT appear in git-ignored paths (they should be committable)
  </verify>
  <done>
Corpus manifest finalized with complete ground_truth_pages mappings for all 4 documents. All ground truth files validated (UTF-8, NFC-normalized, non-empty). Cross-reference confirms no gaps between page selection and ground truth. The evaluation corpus is complete and ready for Phase 17 (Evaluation Framework) and Phase 18 (CER/WER metrics).
  </done>
</task>

</tasks>

<verification>
1. Ground truth files exist in tests/corpus/ground_truth/{doc-id}/ for all selected pages
2. Each ground truth file is UTF-8 encoded, NFC-normalized, and non-empty
3. corpus.json ground_truth_pages mappings match actual files on disk
4. No gaps between page_selection.json and actual ground truth files
5. Human spot-check of 10-15% sample confirms transcription quality
6. Git status shows ground truth and diagnostic files ready to commit (not gitignored)
</verification>

<success_criteria>
- Ground truth text exists for all selected pages (~60-70 total across 4 documents)
- Transcriptions are faithful to source: proper Unicode, paragraph structure, footnote separation
- Manifest is self-describing: any tool can read corpus.json and locate all ground truth, baseline, and PDF files
- Corpus is ready for Phase 17 evaluation and Phase 18 CER/WER computation
- All committable files (manifest, ground truth text, diagnostic JSON, OCR text) are ready for git add
</success_criteria>

<output>
After completion, create `.planning/phases/16-test-corpus-ground-truth/16-03-SUMMARY.md`
</output>
