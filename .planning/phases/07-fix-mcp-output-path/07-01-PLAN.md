---
phase: 07-fix-mcp-output-path
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scholardoc_ocr/types.py
  - src/scholardoc_ocr/pipeline.py
autonomous: true

must_haves:
  truths:
    - "MCP extract_text=True writes a .txt file alongside the output PDF"
    - "MCP output_name renames the output PDF"
    - "MCP result dict includes output_path for each file"
  artifacts:
    - path: "src/scholardoc_ocr/types.py"
      provides: "FileResult with output_path field"
      contains: "output_path"
    - path: "src/scholardoc_ocr/pipeline.py"
      provides: "output_path populated at all return points"
      contains: "output_path"
  key_links:
    - from: "src/scholardoc_ocr/pipeline.py"
      to: "src/scholardoc_ocr/types.py"
      via: "FileResult(output_path=str(pdf_path))"
      pattern: "output_path=str"
    - from: "src/scholardoc_ocr/mcp_server.py"
      to: "FileResult.to_dict()"
      via: "result_dict files[].output_path"
      pattern: "output_path"
---

<objective>
Add output_path field to FileResult and populate it in the pipeline so MCP extract_text and output_name features work.

Purpose: The MCP server reads output_path from result dicts to do text extraction and file renaming. Currently output_path is never set, so both features silently fail.
Output: Working extract_text and output_name MCP features.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@src/scholardoc_ocr/types.py
@src/scholardoc_ocr/pipeline.py
@src/scholardoc_ocr/mcp_server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add output_path to FileResult</name>
  <files>src/scholardoc_ocr/types.py</files>
  <action>
    Add `output_path: str | None = None` field to the FileResult dataclass (after `phase_timings`).

    In `FileResult.to_dict()`, add `output_path` to the returned dict:
    ```python
    if self.output_path is not None:
        d["output_path"] = self.output_path
    ```
  </action>
  <verify>Run `python -c "from scholardoc_ocr.types import FileResult; r = FileResult(filename='test', success=True, engine='tesseract', quality_score=0.9, page_count=1, pages=[], output_path='/tmp/test.pdf'); assert r.to_dict()['output_path'] == '/tmp/test.pdf'"` succeeds.</verify>
  <done>FileResult has output_path field and to_dict() includes it when set.</done>
</task>

<task type="auto">
  <name>Task 2: Populate output_path in pipeline</name>
  <files>src/scholardoc_ocr/pipeline.py</files>
  <action>
    In `_tesseract_worker`, set output_path at each FileResult return point:

    1. Line ~108 (existing text good enough): The pdf_path is `final_dir / f"{input_path.stem}.pdf"`. Add `output_path=str(pdf_path)` to the FileResult constructor.

    2. Line ~130 (Tesseract failed): Leave output_path as None (no output produced).

    3. Line ~176 (Tesseract succeeded): The pdf_path is `final_dir / f"{input_path.stem}.pdf"`. Add `output_path=str(pdf_path)` to the FileResult constructor.

    4. Line ~188 (exception handler): Leave output_path as None.

    Also in `run_pipeline`, line ~292 (worker exception fallback FileResult): Leave output_path as None.

    Do NOT modify the MCP server file -- it already handles output_path correctly.
  </action>
  <verify>Run `ruff check src/scholardoc_ocr/types.py src/scholardoc_ocr/pipeline.py` with no errors. Then grep to confirm: `grep -n "output_path" src/scholardoc_ocr/pipeline.py` shows output_path set at the two success return points.</verify>
  <done>output_path is set to the final PDF path string at both success return points in _tesseract_worker, and left None at error return points.</done>
</task>

</tasks>

<verification>
1. `ruff check src/` passes
2. `pytest` passes (if tests exist)
3. `grep "output_path" src/scholardoc_ocr/types.py src/scholardoc_ocr/pipeline.py` shows the field in types.py and populated at 2 return points in pipeline.py
4. `python -c "from scholardoc_ocr.types import FileResult; r = FileResult(filename='t', success=True, engine='none', quality_score=0.0, page_count=0, pages=[], output_path='/tmp/out.pdf'); d = r.to_dict(); assert d['output_path'] == '/tmp/out.pdf'"` passes
</verification>

<success_criteria>
- FileResult.output_path field exists and serializes in to_dict()
- Pipeline sets output_path=str(pdf_path) at both success return points
- MCP server can now read output_path from result dicts (no MCP changes needed)
</success_criteria>

<output>
After completion, create `.planning/phases/07-fix-mcp-output-path/07-01-SUMMARY.md`
</output>
