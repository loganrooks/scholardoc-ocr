---
phase: 05-cli-presentation-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scholardoc_ocr/pipeline.py
  - src/scholardoc_ocr/types.py
autonomous: true

must_haves:
  truths:
    - "PipelineConfig accepts language parameters that propagate to Tesseract and Surya backends"
    - "Recursive file discovery preserves subdirectory paths"
  artifacts:
    - path: "src/scholardoc_ocr/pipeline.py"
      provides: "PipelineConfig with langs_tesseract and langs_surya fields"
      contains: "langs_tesseract"
    - path: "src/scholardoc_ocr/types.py"
      provides: "LANGUAGE_MAP constant for ISO 639-1 to engine code mapping"
      contains: "LANGUAGE_MAP"
  key_links:
    - from: "src/scholardoc_ocr/pipeline.py"
      to: "Tesseract/Surya config dicts"
      via: "PipelineConfig language fields passed into worker config_dict"
      pattern: "langs_tesseract|langs_surya"
---

<objective>
Add language configuration to PipelineConfig and fix the recursive file discovery bug.

Purpose: Enable the CLI (plan 02) to pass user-specified languages through to OCR backends, and fix the known bug where recursive mode loses subdirectory paths.
Output: Updated PipelineConfig with language fields, language mapping constants, and fixed file discovery logic.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cli-presentation-layer/05-RESEARCH.md

@src/scholardoc_ocr/pipeline.py
@src/scholardoc_ocr/types.py
@src/scholardoc_ocr/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add language mapping and PipelineConfig language fields</name>
  <files>src/scholardoc_ocr/types.py, src/scholardoc_ocr/pipeline.py</files>
  <action>
1. In types.py, add a LANGUAGE_MAP dict that maps ISO 639-1 codes to Tesseract and Surya codes:
```python
LANGUAGE_MAP: dict[str, dict[str, str]] = {
    "en": {"tesseract": "eng", "surya": "en"},
    "fr": {"tesseract": "fra", "surya": "fr"},
    "de": {"tesseract": "deu", "surya": "de"},
    "el": {"tesseract": "ell", "surya": "el"},
    "la": {"tesseract": "lat", "surya": "la"},
}
```
Also add a helper function `resolve_languages(iso_codes: list[str]) -> tuple[str, str]` that returns (tesseract_langs, surya_langs) as comma-separated strings. Default if empty: `("eng,fra,ell,lat,deu", "en,fr,el,la,de")`.

2. In pipeline.py, add two fields to PipelineConfig:
```python
langs_tesseract: str = "eng,fra,ell,lat,deu"
langs_surya: str = "en,fr,el,la,de"
```

3. In pipeline.py `run_pipeline()`, at line ~248 where `config_dict` is constructed, replace the hardcoded `"langs_tesseract": ["eng", "fra", "ell", "lat"]` with `"langs_tesseract": config.langs_tesseract.split(",")` so the Tesseract worker at line ~121 receives user-specified languages. Also add `"langs_surya": config.langs_surya.split(",")` to config_dict.

4. In pipeline.py at line ~357, where `surya.convert_pdf(input_path, model_dict, page_range=bad_indices)` is called, pass the Surya languages: `surya.convert_pdf(input_path, model_dict, page_range=bad_indices, langs=config.langs_surya.split(","))`. Check that `convert_pdf` accepts a `langs` parameter; if it uses a different kwarg name, match accordingly.

5. Export `LANGUAGE_MAP` and `resolve_languages` from `__init__.py` by adding them to the import from `.types` (line ~16) and to the `__all__` list (line ~25). Currently `__init__.py` imports specific types; add these two explicitly.
  </action>
  <verify>
Run `python -c "from scholardoc_ocr.types import LANGUAGE_MAP, resolve_languages; print(resolve_languages(['en','fr']))"` and confirm it prints the correct Tesseract and Surya language strings.
Run `python -c "from scholardoc_ocr.pipeline import PipelineConfig; c = PipelineConfig(); print(c.langs_tesseract, c.langs_surya)"` to confirm defaults.
Run `python -c "from scholardoc_ocr import LANGUAGE_MAP, resolve_languages"` to confirm __init__.py exports work.
Verify config_dict at line ~248 uses `config.langs_tesseract` not hardcoded list.
Verify surya.convert_pdf call at line ~357 passes langs from config.
Run `ruff check src/` passes.
  </verify>
  <done>PipelineConfig has langs_tesseract and langs_surya fields with sensible defaults; language mapping resolves ISO codes to engine-specific codes; hardcoded language strings in pipeline replaced with config values.</done>
</task>

<task type="auto">
  <name>Task 2: Fix recursive file discovery bug</name>
  <files>src/scholardoc_ocr/cli.py</files>
  <action>
Fix the recursive mode bug on line ~171 of cli.py. Currently:
```python
pdf_files = [p.name for p in input_dir.rglob("*.pdf")]
```
This strips subdirectory paths. Change to:
```python
pdf_files = [str(p.relative_to(input_dir)) for p in input_dir.rglob("*.pdf")]
```
This preserves the relative path from input_dir so `config.input_dir / filename` resolves correctly for files in subdirectories.

Also apply the same fix for the non-recursive glob path (though `p.name` works there since files are in the root, using `relative_to` is more consistent):
```python
pdf_files = [str(p.relative_to(input_dir)) for p in input_dir.glob("*.pdf")]
```
  </action>
  <verify>
Create a test directory structure: `mkdir -p /tmp/test_ocr/subdir && touch /tmp/test_ocr/subdir/test.pdf && touch /tmp/test_ocr/root.pdf`
Then verify in Python:
```python
from pathlib import Path
d = Path("/tmp/test_ocr")
files = [str(p.relative_to(d)) for p in d.rglob("*.pdf")]
print(files)  # Should include "subdir/test.pdf" and "root.pdf"
assert any("subdir" in f for f in files)
```
Run `ruff check src/scholardoc_ocr/cli.py` passes.
  </verify>
  <done>Recursive mode preserves subdirectory paths; files in subdirectories are correctly resolved by the pipeline.</done>
</task>

</tasks>

<verification>
- `ruff check src/` passes
- `pytest` passes (existing tests still work)
- PipelineConfig language fields have correct defaults
- Language mapping covers en, fr, de, el, la
- Recursive file discovery preserves relative paths
</verification>

<success_criteria>
PipelineConfig accepts language parameters with sensible defaults. Recursive file discovery bug is fixed. All existing tests pass. The CLI (plan 02) can now use these language fields and the fixed file discovery.
</success_criteria>

<output>
After completion, create `.planning/phases/05-cli-presentation-layer/05-01-SUMMARY.md`
</output>
