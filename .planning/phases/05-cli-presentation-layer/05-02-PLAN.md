---
phase: 05-cli-presentation-layer
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/scholardoc_ocr/cli.py
autonomous: true

must_haves:
  truths:
    - "CLI shows Rich progress bars during Tesseract and Surya phases"
    - "CLI displays 'Loading Surya models...' spinner when Surya initializes"
    - "CLI prints Rich table summary after completion"
    - "New flags --output-dir/-o, --language/-l, -r work correctly"
    - "All existing flags preserved and work identically"
    - "CLI only imports from pipeline, callbacks, and types modules"
  artifacts:
    - path: "src/scholardoc_ocr/cli.py"
      provides: "Complete CLI rewrite with RichCallback and new flags"
      contains: "RichCallback"
  key_links:
    - from: "src/scholardoc_ocr/cli.py"
      to: "run_pipeline"
      via: "RichCallback passed as callback parameter"
      pattern: "run_pipeline.*callback"
    - from: "src/scholardoc_ocr/cli.py"
      to: "types.LANGUAGE_MAP"
      via: "--language flag mapped to PipelineConfig language fields"
      pattern: "resolve_languages"
---

<objective>
Rewrite cli.py as a thin Rich-powered presentation wrapper around the library API.

Purpose: Provide a polished terminal UX with progress bars, spinners, colored output, and a Rich table summary while keeping the CLI as a pure presentation layer that delegates all work to run_pipeline().
Output: Complete cli.py rewrite with RichCallback class, new flags, and Rich summary table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-cli-presentation-layer/05-RESEARCH.md
@.planning/phases/05-cli-presentation-layer/05-01-SUMMARY.md

@src/scholardoc_ocr/cli.py
@src/scholardoc_ocr/callbacks.py
@src/scholardoc_ocr/types.py
@src/scholardoc_ocr/pipeline.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement RichCallback class</name>
  <files>src/scholardoc_ocr/cli.py</files>
  <action>
Create a `RichCallback` class in cli.py that implements the `PipelineCallback` protocol using Rich:

1. **Constructor:** Takes a `Console` instance. Initializes `_progress: Progress | None = None` and `_task_id = None`.

2. **on_phase(event: PhaseEvent):**
   - On `status == "started"`: Create and start a `rich.progress.Progress` with SpinnerColumn, TextColumn (bold blue description), BarColumn, TaskProgressColumn, TimeRemainingColumn. Add a task with `total=event.files_count`. Store progress and task_id.
   - On `status == "completed"`: Stop progress, set to None.

3. **on_progress(event: ProgressEvent):**
   - If progress active, update task with `completed=event.current` and description showing `{event.phase}: {event.filename or ''}`.

4. **on_model(event: ModelEvent):**
   - On `status == "loading"`: Print `[yellow]Loading {event.model_name} models...[/]` via console.
   - On `status == "loaded"`: Print `[green]{event.model_name} models loaded ({event.time_seconds:.1f}s)[/]`.

Import only from: `pipeline` (PipelineConfig, run_pipeline), `callbacks` (PipelineCallback, ProgressEvent, PhaseEvent, ModelEvent), `types` (BatchResult, FileResult, OCREngine, resolve_languages). Do NOT import processor, quality, surya, tesseract, or any other backend module.
  </action>
  <verify>
Run `python -c "from scholardoc_ocr.cli import RichCallback"` succeeds.
Run `ruff check src/scholardoc_ocr/cli.py` passes.
Verify cli.py has NO imports from processor, quality, surya, or tesseract modules.
  </verify>
  <done>RichCallback class implements PipelineCallback with Rich progress bars, model loading messages, and phase lifecycle management.</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite CLI with new flags and Rich summary</name>
  <files>src/scholardoc_ocr/cli.py</files>
  <action>
Rewrite the `main()` function and `_print_summary()`:

1. **New/changed flags in argparse:**
   - Rename `--output` to `--output-dir` (keep `-o` short flag). Add `mkdir -p` behavior (create dir if not exists).
   - Add `--language` / `-l` flag accepting comma-separated ISO 639-1 codes (e.g., `en,fr,de`). Default: `en,fr,el,la,de`. Use `resolve_languages()` from types to map to Tesseract/Surya codes.
   - `-r` already exists as short flag for `--recursive` (confirmed in current code).
   - Add `--no-color` flag that creates `Console(no_color=True)`. Also respect `NO_COLOR` env var (Rich does this automatically).
   - Add `--version` flag using `parser.add_argument("--version", action="version", version="scholardoc-ocr 0.1.0")`.
   - Keep ALL existing flags: positional input_dir, -q/--quality, --force, --force-surya, --debug, -s/--samples, -w/--workers, -f/--files, -r/--recursive, -v/--verbose.

2. **Console and callback setup:**
   - Create `Console(no_color=args.no_color or os.environ.get("NO_COLOR") is not None)` (though Rich handles NO_COLOR automatically, explicit is fine).
   - Create `RichCallback(console)`.
   - Pass `callback=callback` to `run_pipeline(config, callback=callback)`.

3. **Output directory:**
   - If `--output-dir` provided, use it. Create with `output_dir.mkdir(parents=True, exist_ok=True)`.
   - If not provided, default to `input_dir / "ocr_output"` (current behavior).

4. **Language handling:**
   - Parse `--language` value, split by comma, pass to `resolve_languages()`.
   - Set `config.langs_tesseract` and `config.langs_surya` from result.

5. **Rich summary table (replace `_print_summary()`):**
   - Create `rich.table.Table(title="OCR Pipeline Summary")`.
   - Columns: Filename (cyan), Pages (right-aligned), Quality (right-aligned), Engine, Time (right-aligned).
   - Color quality: green if >= threshold, yellow otherwise.
   - Show errors in red.
   - Print totals line below table: total files, successful, errors, total time.
   - In debug mode, show flagged page details as before but using console.print with colors.

6. **Exit codes:** 0 if no errors, 1 if any errors. Same as current behavior.

7. **Error handling:** Wrap `run_pipeline()` in try/except. On unexpected exceptions, print clean error message (not traceback) unless --debug is set. On KeyboardInterrupt, print "Interrupted" and exit 130.
  </action>
  <verify>
Run `python -m scholardoc_ocr.cli --help` and confirm all flags appear including new ones (--output-dir, --language, --version, --no-color).
Run `python -m scholardoc_ocr.cli --version` prints version.
Run `ruff check src/scholardoc_ocr/cli.py` passes.
Verify cli.py imports ONLY from pipeline, callbacks, types (plus stdlib and rich).
  </verify>
  <done>CLI rewritten with Rich progress, new flags, Rich table summary, clean error handling. All existing flags preserved. CLI imports only from library API modules.</done>
</task>

</tasks>

<verification>
- `ruff check src/` passes
- `python -m scholardoc_ocr.cli --help` shows all flags
- `python -m scholardoc_ocr.cli --version` works
- cli.py contains NO imports from processor, quality, surya, tesseract modules
- RichCallback class exists and implements on_progress, on_phase, on_model
- Summary uses Rich table
</verification>

<success_criteria>
CLI is a thin Rich-powered wrapper. RichCallback drives progress display via the existing callback protocol. New flags (--output-dir, --language, --no-color, --version) work alongside all preserved existing flags. Summary output uses Rich tables. CLI only imports from pipeline, callbacks, and types.
</success_criteria>

<output>
After completion, create `.planning/phases/05-cli-presentation-layer/05-02-SUMMARY.md`
</output>
