---
phase: 02-quality-analysis-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scholardoc_ocr/confidence.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "Confidence extraction renders a PDF page to image and returns per-word confidence scores"
    - "Confidence signal produces a 0-1 score from word-level confidence data"
    - "Non-text elements (conf=-1) are filtered before aggregation"
    - "pytesseract is declared as a project dependency"
  artifacts:
    - path: "src/scholardoc_ocr/confidence.py"
      provides: "ConfidenceSignal class and extract_page_confidence function"
      exports: ["ConfidenceSignal", "extract_page_confidence"]
    - path: "pyproject.toml"
      provides: "pytesseract dependency declaration"
      contains: "pytesseract"
  key_links:
    - from: "src/scholardoc_ocr/confidence.py"
      to: "pytesseract"
      via: "image_to_data()"
      pattern: "pytesseract\\.image_to_data"
    - from: "src/scholardoc_ocr/confidence.py"
      to: "fitz"
      via: "page.get_pixmap(dpi=300)"
      pattern: "get_pixmap"
---

<objective>
Create the Tesseract confidence extraction module.

Purpose: Provides OCR confidence as a quality signal by running pytesseract.image_to_data() on PDF page images rendered via PyMuPDF. This is the most direct measure of OCR quality.
Output: confidence.py module with extraction function and signal scorer, pytesseract added to dependencies.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quality-analysis-enhancement/02-RESEARCH.md
@src/scholardoc_ocr/quality.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pytesseract dependency and create confidence module</name>
  <files>pyproject.toml, src/scholardoc_ocr/confidence.py</files>
  <action>
Add `pytesseract>=0.3.10` to the `dependencies` list in pyproject.toml. Then run `pip install -e ".[dev]"` to install.

Create `src/scholardoc_ocr/confidence.py` with:

1. `extract_page_confidence(pdf_path: Path, page_num: int, langs: str = "eng+fra") -> list[dict]`:
   - Opens PDF with fitz.open (use context manager)
   - Gets page by page_num index
   - Renders at 300 DPI via page.get_pixmap(dpi=300)
   - Converts to PIL Image via io.BytesIO(pix.tobytes("png"))
   - Runs pytesseract.image_to_data(img, lang=langs, output_type=pytesseract.Output.DICT)
   - Filters results: only include entries where text.strip() != "" AND conf > 0
   - Returns list of {"text": str, "conf": int} dicts (conf is 0-100)

2. Import `SignalResult` from types.py: `from scholardoc_ocr.types import SignalResult`.

3. `ConfidenceSignal` class:
   ```python
   class ConfidenceSignal:
       def __init__(self, langs: str = "eng+fra"):
           self.langs = langs

       def score_from_data(self, confidence_data: list[dict]) -> SignalResult:
           # confidence_data is list of {"text": str, "conf": int}
           # Filter: only words with conf > 0 and text.strip()
           # Weight by word length: longer words' confidence matters more
           # Compute weighted mean confidence (0-100), normalize to 0-1
           # Handle empty data gracefully (return score=0.5, "no_data" in details)
           # Return SignalResult(name="confidence", score=normalized, passed=..., details={...})

       def score_from_pdf(self, pdf_path: Path, page_num: int) -> SignalResult:
           # Convenience: extract + score in one call
           data = extract_page_confidence(pdf_path, page_num, self.langs)
           return self.score_from_data(data)
   ```

Key implementation details:
- conf=-1 means non-text element in Tesseract — MUST filter these out
- Weight by word length: `weight = max(1, len(word["text"]))`, then weighted average
- Normalize 0-100 Tesseract scale to 0-1 by dividing by 100
- If no valid words found, return score=0.5 (neutral, don't penalize empty pages)
- Include in details: word_count, mean_conf, min_conf, low_conf_words (words with conf < 30)
  </action>
  <verify>
`python -c "from scholardoc_ocr.confidence import ConfidenceSignal, extract_page_confidence; print('imports ok')"` succeeds.
`python -c "from scholardoc_ocr.confidence import ConfidenceSignal; s = ConfidenceSignal(); r = s.score_from_data([{'text': 'hello', 'conf': 95}, {'text': 'world', 'conf': 90}]); print(r.score, r.details)"` returns score ~0.92.
`python -c "from scholardoc_ocr.confidence import ConfidenceSignal; s = ConfidenceSignal(); r = s.score_from_data([]); print(r.score)"` returns 0.5 (empty data).
  </verify>
  <done>Confidence module extracts word-level confidence from PDF pages via pytesseract, filters non-text entries, produces weighted 0-1 score. pytesseract declared as dependency. Note: score_from_data is verified with mock dict data only — real PDF extraction (score_from_pdf) requires Tesseract binary + test fixture, tested in integration tests.</done>
</task>

</tasks>

<verification>
- `python -c "import pytesseract; print(pytesseract.__version__)"` succeeds
- `python -c "from scholardoc_ocr.confidence import ConfidenceSignal, extract_page_confidence"` imports succeed
- ConfidenceSignal.score_from_data handles empty input gracefully
- ConfidenceSignal.score_from_data produces reasonable scores for test data
</verification>

<success_criteria>
Confidence extraction module exists, pytesseract is a dependency, ConfidenceSignal scores OCR confidence data as a 0-1 signal. PDF-to-image rendering uses PyMuPDF at 300 DPI.
</success_criteria>

<output>
After completion, create `.planning/phases/02-quality-analysis-enhancement/02-02-SUMMARY.md`
</output>
