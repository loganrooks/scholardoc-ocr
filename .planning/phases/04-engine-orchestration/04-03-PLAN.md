---
phase: 04-engine-orchestration
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - tests/test_pipeline.py
autonomous: true

must_haves:
  truths:
    - "Integration test verifies Tesseract phase produces FileResult with PageResult per page"
    - "Integration test verifies Surya writeback actually modifies the output .txt file"
    - "Integration test verifies per-file Surya failure does not crash the pipeline"
    - "Integration test verifies resource-aware worker calculation"
    - "Test verifies PipelineConfig.force_surya flag triggers Surya on all pages"
  artifacts:
    - path: "tests/test_pipeline.py"
      provides: "Pipeline integration tests"
      contains: "def test_"
  key_links:
    - from: "tests/test_pipeline.py"
      to: "src/scholardoc_ocr/pipeline.py"
      via: "imports run_pipeline, PipelineConfig"
      pattern: "from scholardoc_ocr\\.pipeline import"
---

<objective>
Create integration tests for pipeline orchestration covering both phases, Surya writeback, partial failure, resource-aware parallelism, and force_surya flag.

Purpose: Satisfies TEST-03 and TEST-04 requirements. Verifies the two critical bugs (BUG-01, BUG-02) are actually fixed by testing that Surya text appears in output files.

Output: tests/test_pipeline.py with comprehensive pipeline integration tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-engine-orchestration/04-01-SUMMARY.md

@src/scholardoc_ocr/pipeline.py
@src/scholardoc_ocr/types.py
@tests/conftest.py
@tests/test_tesseract.py
@tests/test_surya.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pipeline integration tests</name>
  <files>tests/test_pipeline.py</files>
  <action>
Create tests/test_pipeline.py with the following tests. Use `unittest.mock.patch` to mock the OCR backends (tesseract.run_ocr, surya.load_models, surya.convert_pdf) and PDFProcessor methods so tests run without actual OCR engines installed. Use `tmp_path` fixture for file I/O.

**Test helpers:**
- `_create_mock_pdf(path)`: Creates a minimal file at path (just needs to exist for mocking)
- `_make_config(tmp_path, **overrides)` -> PipelineConfig: Creates config pointing to tmp_path with sensible defaults

**Tests:**

1. `test_pipeline_returns_batch_result`: Create 1 mock PDF. Mock tesseract.run_ocr to succeed, processor.extract_text_by_page to return ["good text"] per page, quality analyzer to return all-good results. Call run_pipeline(). Assert returns BatchResult, has 1 FileResult, FileResult.success is True.

2. `test_pipeline_tesseract_only_no_surya_needed`: Mock all pages passing quality. Assert surya.load_models is NOT called. Assert surya.convert_pdf is NOT called.

3. `test_pipeline_surya_writeback`: Mock 1 file with 3 pages where page 1 (0-indexed) is flagged below threshold. Mock surya.convert_pdf to return "SURYA_ENHANCED_TEXT". Create initial .txt file in final/ with "page0\n\nBAD_PAGE\n\npage2". After run_pipeline(), read the .txt file and assert "SURYA_ENHANCED_TEXT" appears in it (BUG-01 fix verification). This is TEST-04.

4. `test_pipeline_surya_failure_partial_success`: Mock 2 files both flagged. Mock surya.convert_pdf to raise SuryaError on first file but succeed on second. Assert pipeline returns BatchResult with both files. First file keeps Tesseract output. Second file has Surya text.

5. `test_pipeline_force_surya`: Create config with force_surya=True. Mock all pages as good quality. Assert surya.load_models IS called and surya.convert_pdf IS called for every file.

6. `test_resource_aware_workers`: Test the worker calculation logic. With 8 cores and 2 files: jobs_per_file should be 4, pool_workers should be 2. With 8 cores and 16 files: jobs_per_file should be 1, pool_workers should be 8 (capped at max_workers). Verify by patching os.cpu_count and checking the effective values used.

7. `test_pipeline_empty_input`: Config with no files. Assert returns BatchResult with empty files list.

8. `test_pipeline_config_force_surya_field`: Assert PipelineConfig has force_surya field defaulting to False.

Mock strategy:
- Patch `scholardoc_ocr.pipeline.tesseract.run_ocr` (or wherever the pipeline imports it)
- Patch `scholardoc_ocr.pipeline.surya.load_models` and `scholardoc_ocr.pipeline.surya.convert_pdf`
- Patch `scholardoc_ocr.pipeline.PDFProcessor.extract_text_by_page` and `get_page_count`
- Patch `scholardoc_ocr.pipeline.QualityAnalyzer.analyze_pages`

For the writeback test (test 3), actually write a real .txt file in tmp_path and verify its contents change.
  </action>
  <verify>
Run `pytest tests/test_pipeline.py -v` — all tests pass.
Run `ruff check tests/test_pipeline.py` — no lint errors.
  </verify>
  <done>
Pipeline integration tests cover: BatchResult return type, Tesseract-only path, Surya writeback (TEST-04 / BUG-01 verification), partial Surya failure, force_surya flag, resource-aware parallelism, empty input handling.
  </done>
</task>

</tasks>

<verification>
- `pytest tests/test_pipeline.py -v` — all tests pass
- `ruff check tests/test_pipeline.py` — clean
- At least 8 test functions exist
- `grep -c "SURYA_ENHANCED_TEXT" tests/test_pipeline.py` >= 1 (writeback test)
- `grep -c "SuryaError" tests/test_pipeline.py` >= 1 (partial failure test)
</verification>

<success_criteria>
Pipeline integration tests verify both bug fixes, per-file Surya processing, partial failure handling, force_surya, and resource-aware parallelism. All tests pass with mocked backends.
</success_criteria>

<output>
After completion, create `.planning/phases/04-engine-orchestration/04-03-SUMMARY.md`
</output>
