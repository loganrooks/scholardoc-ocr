---
phase: 09-post-processing
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/scholardoc_ocr/postprocess.py
  - tests/test_postprocess.py
autonomous: true

must_haves:
  truths:
    - "All extracted text is NFC-normalized with ligatures decomposed and soft hyphens removed"
    - "Paragraphs are joined into continuous text while paragraph boundaries are preserved"
    - "Line-break hyphens are rejoined but German compounds and French names keep their hyphens"
    - "Extra whitespace around punctuation is collapsed"
  artifacts:
    - path: "src/scholardoc_ocr/postprocess.py"
      provides: "Text post-processing transforms"
      exports: ["postprocess", "normalize_unicode", "join_paragraphs", "dehyphenate", "normalize_punctuation"]
    - path: "tests/test_postprocess.py"
      provides: "Tests for all transform functions"
      min_lines: 80
  key_links:
    - from: "src/scholardoc_ocr/postprocess.py"
      to: "src/scholardoc_ocr/quality.py"
      via: "imports _GarbledSignal.VALID_TERMS for dehyphenation whitelist"
      pattern: "from .quality import"
---

<objective>
Create the postprocess.py module with all text transform functions, using TDD.

Purpose: POST-01 through POST-07 -- produce RAG-ready text from OCR output.
Output: Tested postprocess.py module with normalize_unicode, join_paragraphs, dehyphenate, normalize_punctuation, and top-level postprocess() pipeline function.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/scholardoc_ocr/quality.py (reuse _GarbledSignal.VALID_TERMS for dehyphenation whitelist)
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Write failing tests for all transforms</name>
  <files>tests/test_postprocess.py, src/scholardoc_ocr/postprocess.py</files>
  <action>
Create tests/test_postprocess.py with tests covering all 7 requirements:

**normalize_unicode (POST-01, POST-02, POST-03):**
- NFC normalization: composed chars stay composed (e.g. "cafe\u0301" -> "cafe")
- Soft hyphen removal: "Selbst\u00ADbewusstsein" -> "Selbstbewusstsein"
- Ligature decomposition: "\uFB01" -> "fi", "\uFB02" -> "fl", "\uFB00" -> "ff", "\uFB03" -> "ffi", "\uFB04" -> "ffl"

**join_paragraphs (POST-04):**
- Single newline within paragraph -> space: "word\nword" -> "word word"
- Double newline preserved as paragraph boundary: "para1\n\nPara2" stays split
- Short lines (headings) NOT joined to next paragraph
- Indented lines start new paragraph

**dehyphenate (POST-05, POST-06):**
- Basic line-break hyphen: "knowl-\nedge" -> "knowledge"
- German compound preserved: "Selbstbewusst-\nsein" -> "Selbstbewusstsein" (rejoined because full word is in VALID_TERMS)
- French name preserved: "Merleau-\nPonty" stays "Merleau-Ponty" (intentional hyphen)
- General hyphenated compound not at line break preserved: "well-known" stays "well-known"

**normalize_punctuation (POST-07):**
- Space before period removed: "word ." -> "word."
- Double space collapsed: "word  word" -> "word word"
- Space before comma removed: "word , word" -> "word, word"

**postprocess (integration):**
- Full pipeline test with mixed issues returns clean text

Create a minimal stub postprocess.py that imports but has functions returning empty strings, so tests can import but will fail.

Run `pytest tests/test_postprocess.py` -- all tests MUST fail (red).
  </action>
  <verify>pytest tests/test_postprocess.py exits non-zero, all tests fail with assertion errors (not import errors)</verify>
  <done>Test file exists with 10+ test cases covering all 7 POST requirements, all failing against stubs</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement all transforms to pass tests</name>
  <files>src/scholardoc_ocr/postprocess.py</files>
  <action>
Implement postprocess.py with these functions:

**normalize_unicode(text: str) -> str:**
- Apply unicodedata.normalize("NFC", text)
- Replace 5 ligatures: {"\uFB00": "ff", "\uFB01": "fi", "\uFB02": "fl", "\uFB03": "ffi", "\uFB04": "ffl"}
- Remove soft hyphens (U+00AD)

**join_paragraphs(text: str) -> str:**
- Split on double newlines to get paragraph blocks
- Within each block, replace single newlines with spaces (but preserve double newlines as paragraph separators)
- Detect short lines (< 60 chars followed by a line starting with uppercase or blank) as paragraph boundaries -- do NOT join those

**dehyphenate(text: str, terms: frozenset[str] | None = None) -> str:**
- Default terms: import from quality.py: `from .quality import _GarbledSignal; terms = _GarbledSignal.VALID_TERMS`
- Pattern: `(\w+)-\n(\w+)` at line breaks
- If the joined word (lowercased) is in terms OR the left part + right part form a common word, rejoin without hyphen
- If the hyphenated form (e.g. "Merleau-Ponty") is a known name/term, keep hyphen. Use a small set of known hyphenated terms: {"merleau-ponty", "sartre-beauvoir", "buber-rosenzweig"} plus any where both parts are capitalized (proper name heuristic)
- For remaining cases: rejoin (assume line-break hyphen) -- this is the common OCR case

**normalize_punctuation(text: str) -> str:**
- re.sub(r'\s+([.,;:!?])', r'\1', text) -- remove space before punctuation
- re.sub(r'  +', ' ', text) -- collapse multiple spaces
- Strip trailing whitespace per line

**postprocess(text: str) -> str:**
- Chain: normalize_unicode -> join_paragraphs -> dehyphenate -> normalize_punctuation

Run `pytest tests/test_postprocess.py` -- all tests MUST pass (green).
  </action>
  <verify>pytest tests/test_postprocess.py exits 0, all tests pass</verify>
  <done>All transform functions implemented and passing tests</done>
</task>

</tasks>

<verification>
- `pytest tests/test_postprocess.py -v` -- all pass
- `ruff check src/scholardoc_ocr/postprocess.py` -- no lint errors
- `python -c "from scholardoc_ocr.postprocess import postprocess; print(postprocess('test\uFB01le'))"` prints "tefile"
</verification>

<success_criteria>
- postprocess.py exists with 5 exported functions
- All 7 POST requirements covered by tests
- All tests green
- No lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-post-processing/09-01-SUMMARY.md`
</output>
