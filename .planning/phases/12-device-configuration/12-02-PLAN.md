---
phase: 12-device-configuration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scholardoc_ocr/types.py
  - tests/test_types.py
autonomous: true

must_haves:
  truths:
    - "FileResult includes device_used field for tracking which device processed the file"
    - "device_used appears in FileResult.to_dict() serialization"
  artifacts:
    - path: "src/scholardoc_ocr/types.py"
      provides: "Device tracking in FileResult"
      contains: "device_used"
  key_links:
    - from: "src/scholardoc_ocr/types.py"
      to: "FileResult dataclass"
      via: "device_used field"
      pattern: "device_used.*str.*None"
---

<objective>
Add device tracking metadata to FileResult for transparency about GPU/CPU usage.

Purpose: Track which device (cuda/mps/cpu) processed each file, enabling debugging
         of performance issues and validation that GPU acceleration is working.

Output: device_used field in FileResult dataclass.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-device-configuration/12-RESEARCH.md

Reference existing types:
@src/scholardoc_ocr/types.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add device_used field to FileResult</name>
  <files>src/scholardoc_ocr/types.py</files>
  <action>
Modify FileResult dataclass in types.py:

1. Add new field after output_path:
   ```python
   device_used: str | None = None  # Device that processed this file (cuda/mps/cpu)
   ```

2. Update to_dict() method to include device_used:
   ```python
   if self.device_used is not None:
       d["device_used"] = self.device_used
   ```

This provides transparency about which device processed each file, useful for:
- Debugging performance issues
- Validating GPU acceleration is working
- Understanding fallback behavior
  </action>
  <verify>
Run: python -c "from scholardoc_ocr.types import FileResult, OCREngine, PageStatus; f = FileResult(filename='test.pdf', success=True, engine=OCREngine.TESSERACT, quality_score=0.9, page_count=1, pages=[], device_used='mps'); print(f.to_dict())"

Expected: Output includes "device_used": "mps"
  </verify>
  <done>
FileResult includes device_used field and serializes it in to_dict()
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for device_used field</name>
  <files>tests/test_types.py</files>
  <action>
Add tests for device_used field to test_types.py (create file if it doesn't exist):

1. Test device_used field exists and defaults to None:
   ```python
   def test_file_result_device_used_default():
       """Verify device_used defaults to None."""
       from scholardoc_ocr.types import FileResult, OCREngine

       result = FileResult(
           filename="test.pdf",
           success=True,
           engine=OCREngine.TESSERACT,
           quality_score=0.9,
           page_count=1,
           pages=[],
       )
       assert result.device_used is None
   ```

2. Test device_used appears in to_dict():
   ```python
   def test_file_result_device_used_in_to_dict():
       """Verify device_used is serialized in to_dict() when set."""
       from scholardoc_ocr.types import FileResult, OCREngine

       result = FileResult(
           filename="test.pdf",
           success=True,
           engine=OCREngine.TESSERACT,
           quality_score=0.9,
           page_count=1,
           pages=[],
           device_used="mps",
       )
       d = result.to_dict()
       assert d["device_used"] == "mps"
   ```

3. Test device_used omitted from to_dict() when None:
   ```python
   def test_file_result_device_used_omitted_when_none():
       """Verify device_used is not in to_dict() when None."""
       from scholardoc_ocr.types import FileResult, OCREngine

       result = FileResult(
           filename="test.pdf",
           success=True,
           engine=OCREngine.TESSERACT,
           quality_score=0.9,
           page_count=1,
           pages=[],
       )
       d = result.to_dict()
       assert "device_used" not in d
   ```
  </action>
  <verify>
Run: pytest tests/test_types.py -v -k "device_used"

Expected: All device_used tests pass
  </verify>
  <done>
Unit tests verify device_used field behavior in FileResult
  </done>
</task>

</tasks>

<verification>
1. `ruff check src/scholardoc_ocr/types.py` - no lint errors
2. `ruff format --check src/scholardoc_ocr/types.py` - properly formatted
3. `pytest tests/test_types.py -v` - all tests pass
</verification>

<success_criteria>
- FileResult.device_used tracks which device processed each file
- Field is optional (None by default) for backward compatibility
- Serialized in to_dict() only when set (clean JSON output)
</success_criteria>

<output>
After completion, create `.planning/phases/12-device-configuration/12-02-SUMMARY.md`
</output>
