---
phase: 01-foundation-and-data-structures
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scholardoc_ocr/processor.py
  - src/scholardoc_ocr/pipeline.py
  - src/scholardoc_ocr/__init__.py
autonomous: true

must_haves:
  truths:
    - "No Rich imports in library code (pipeline.py, processor.py)"
    - "All fitz document operations use context managers"
    - "No sys.exit() in library code"
    - "Dead code removed (run_surya_on_pages)"
    - "Invalid type annotations fixed (lowercase callable)"
    - "Stale Levinas naming replaced with ScholarDoc"
  artifacts:
    - path: "src/scholardoc_ocr/processor.py"
      provides: "PDFProcessor with context-managed fitz operations"
      contains: "@contextmanager"
    - path: "src/scholardoc_ocr/pipeline.py"
      provides: "Pipeline functions without Rich imports"
    - path: "src/scholardoc_ocr/__init__.py"
      provides: "Updated package docstring and version"
  key_links:
    - from: "src/scholardoc_ocr/processor.py"
      to: "fitz"
      via: "context manager wrapping doc open/close"
      pattern: "with self\\._open_pdf"
---

<objective>
Clean up existing code: remove Rich coupling from library, add context managers for PDF operations, fix type annotations, remove dead code, update stale naming.

Purpose: This makes the existing code safe and library-ready before integrating the new types/callbacks/exceptions from Plan 01. These are independent changes that don't require the new modules.

Output: Cleaned processor.py, pipeline.py, and __init__.py
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-data-structures/01-CONTEXT.md
@.planning/phases/01-foundation-and-data-structures/01-RESEARCH.md
@src/scholardoc_ocr/processor.py
@src/scholardoc_ocr/pipeline.py
@src/scholardoc_ocr/__init__.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context managers and clean up processor.py</name>
  <files>src/scholardoc_ocr/processor.py</files>
  <action>
Modify `src/scholardoc_ocr/processor.py`:

**1. Add context manager for fitz documents:**
```python
from contextlib import contextmanager

@contextmanager
def _open_pdf(self, pdf_path: Path | None = None):
    """Context manager for PyMuPDF document. Pass None for empty doc."""
    doc = self.fitz.open(pdf_path) if pdf_path else self.fitz.open()
    try:
        yield doc
    finally:
        doc.close()
```

**2. Refactor ALL methods to use the context manager:**
- `extract_text`: `with self._open_pdf(pdf_path) as doc:`
- `extract_text_by_page`: same pattern
- `extract_pages`: use `with self._open_pdf(pdf_path) as doc:` and `with self._open_pdf() as new_doc:`
- `replace_pages`: three documents, nest or use multiple context managers
- `get_page_count`: use context manager
- `combine_pages_from_multiple_pdfs`: use context manager for combined doc, and for each source doc in the loop

**3. Remove dead code:**
- Delete the entire `run_surya_on_pages` method (lines 335-383). This is dead code per RESEARCH.md — the pipeline uses `run_surya_batch` instead.

**4. Fix type annotation:**
- In `run_surya_batch` signature (line 250), change `progress_callback: callable = None` to `progress_callback: Callable[[str, int, int], None] | None = None` (import `Callable` from `typing`)

**5. Keep everything else unchanged** — method signatures, return types, behavior all stay the same. This is purely structural cleanup.
  </action>
  <verify>
Run: `python -c "from scholardoc_ocr.processor import PDFProcessor; print('import OK')"` — must succeed.
Run: `ruff check src/scholardoc_ocr/processor.py` — must pass.
Run: `grep -c 'run_surya_on_pages' src/scholardoc_ocr/processor.py` — must return 0.
Run: `grep -c '@contextmanager' src/scholardoc_ocr/processor.py` — must return 1 (the decorator).
Run: `grep 'callable' src/scholardoc_ocr/processor.py` — must NOT show lowercase `callable` as a type hint.
  </verify>
  <done>All fitz operations use context managers, dead code removed, type annotation fixed</done>
</task>

<task type="auto">
  <name>Task 2: Remove Rich from pipeline.py, update __init__.py</name>
  <files>src/scholardoc_ocr/pipeline.py, src/scholardoc_ocr/__init__.py</files>
  <action>
**pipeline.py changes:**

1. Remove ALL Rich imports (lines 12-15): `from rich.console import Console`, `from rich.panel import Panel`, `from rich.progress import ...`, `from rich.table import Table`
2. Remove `console = Console()` (line 21)
3. Remove `_print_debug_info` function entirely (lines 252-290) — this is presentation code
4. In `run_pipeline`:
   - Remove ALL `console.print(...)` calls
   - Remove the Rich `Live` display code (the status table, `make_status_table`, `with Live(...)`)
   - Remove the Rich summary Panel at the end
   - Remove the Rich imports inside the function (`from rich.live import Live`, `from rich.table import Table`)
   - Keep the core logic: file discovery, parallel Tesseract execution, Surya batch processing, result collection
   - Replace Rich output with `logger.info(...)` calls for key milestones (phase start, file completion, phase end)
   - The function should still return `list[ExtendedResult]` — behavior unchanged, only presentation removed
5. Fix stale naming: change "LEVINAS OCR PIPELINE" string if present to "ScholarDoc OCR Pipeline" (only in log messages)
6. Remove `from rich.live import Live` and `from rich.table import Table` inside the function body (lines 362-363, 513-514)

**__init__.py changes:**

1. Update docstring from `"""Levinas OCR - High-performance OCR for philosophical texts."""` to `"""ScholarDoc OCR - Hybrid OCR pipeline for academic texts."""`
2. Keep `__version__ = "0.1.0"` unchanged

**IMPORTANT:** Do NOT change `_process_single` function behavior. Do NOT change `run_pipeline` return type or core logic. Only remove Rich presentation and replace with logging.
  </action>
  <verify>
Run: `python -c "from scholardoc_ocr.pipeline import run_pipeline; print('import OK')"` — must succeed WITHOUT Rich installed as an import-time dependency.
Run: `grep -c 'rich' src/scholardoc_ocr/pipeline.py` — must return 0.
Run: `grep -c 'console' src/scholardoc_ocr/pipeline.py` — must return 0.
Run: `grep -ci 'levinas' src/scholardoc_ocr/pipeline.py src/scholardoc_ocr/__init__.py` — must return 0.
Run: `ruff check src/scholardoc_ocr/pipeline.py src/scholardoc_ocr/__init__.py` — must pass.
  </verify>
  <done>pipeline.py has zero Rich imports, uses logging instead, stale Levinas naming gone from __init__.py and pipeline.py</done>
</task>

</tasks>

<verification>
1. `python -c "from scholardoc_ocr.processor import PDFProcessor; from scholardoc_ocr.pipeline import run_pipeline"` succeeds
2. `grep -r 'from rich' src/scholardoc_ocr/pipeline.py src/scholardoc_ocr/processor.py` returns nothing
3. `grep -r 'run_surya_on_pages' src/scholardoc_ocr/` returns nothing
4. `ruff check src/scholardoc_ocr/` passes
5. No lowercase `callable` type hint anywhere
</verification>

<success_criteria>
- Zero Rich imports in processor.py and pipeline.py
- All fitz document operations wrapped in context managers
- run_surya_on_pages dead code deleted
- lowercase callable type annotation fixed
- Levinas naming replaced with ScholarDoc
- All existing behavior preserved (return types, core logic unchanged)
- ruff passes
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-data-structures/01-02-SUMMARY.md`
</output>
