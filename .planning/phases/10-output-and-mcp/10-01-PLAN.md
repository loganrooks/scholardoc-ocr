---
phase: 10-output-and-mcp
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/scholardoc_ocr/pipeline.py
  - src/scholardoc_ocr/cli.py
  - src/scholardoc_ocr/types.py
autonomous: true

must_haves:
  truths:
    - "A .json metadata file appears alongside each output PDF in final/ containing per-page quality scores, engine provenance, and timing stats"
    - "ocr --extract-text writes a .txt file alongside the output PDF; without the flag, no .txt is left in final/"
    - "ocr --json prints structured JSON to stdout and suppresses Rich progress output"
  artifacts:
    - path: "src/scholardoc_ocr/pipeline.py"
      provides: "JSON metadata writing after Phase 2, extract_text config control"
      contains: "json.dumps"
    - path: "src/scholardoc_ocr/cli.py"
      provides: "--extract-text and --json CLI flags"
      contains: "extract-text"
    - path: "src/scholardoc_ocr/types.py"
      provides: "BatchResult.to_json used for --json output"
  key_links:
    - from: "cli.py"
      to: "PipelineConfig"
      via: "extract_text flag mapped to config"
    - from: "pipeline.py"
      to: "types.py FileResult.to_dict()"
      via: "JSON metadata file written from to_dict()"
    - from: "cli.py --json"
      to: "BatchResult.to_json()"
      via: "stdout print when --json flag set"
---

<objective>
Add structured output formats to the pipeline: JSON metadata files alongside PDFs (OUTP-01), opt-in text extraction via --extract-text (OUTP-02), and --json stdout output (OUTP-05).

Purpose: Programmatic consumers (scripts, RAG pipelines, MCP) need structured access to quality scores, engine provenance, and extracted text without parsing Rich console output.
Output: Updated pipeline.py (JSON write + extract_text control), cli.py (two new flags), passing tests.
</objective>

<execution_context>
@/Users/rookslog/.claude/get-shit-done/workflows/execute-plan.md
@/Users/rookslog/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-output-and-mcp/10-RESEARCH.md
@src/scholardoc_ocr/pipeline.py
@src/scholardoc_ocr/cli.py
@src/scholardoc_ocr/types.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: JSON metadata file + extract_text config control</name>
  <files>src/scholardoc_ocr/pipeline.py</files>
  <action>
1. Add `extract_text: bool = False` field to `PipelineConfig` dataclass.

2. In `run_pipeline()`, AFTER Phase 2 (Surya) completes and results are finalized (after the surya_results merge loop), add a JSON metadata writing step:
   ```python
   import json
   final_dir = config.output_dir / "final"
   for file_result in batch_result.files:
       if file_result.success and file_result.output_path:
           stem = Path(file_result.output_path).stem
           metadata = file_result.to_dict(include_text=False)
           json_path = final_dir / f"{stem}.json"
           json_path.write_text(json.dumps(metadata, indent=2), encoding="utf-8")
   ```
   IMPORTANT: This must happen AFTER Surya updates page results, not in the worker. The research doc explains why (Surya mutates FileResult.pages in-place during Phase 2).

3. Control .txt file persistence: The pipeline currently writes .txt files to `final/` during processing. Add a cleanup step at the end of `run_pipeline()` that removes .txt files from `final/` unless `config.extract_text` is True. Do NOT prevent internal text extraction (quality analysis needs it) — only control whether .txt persists in the output directory.
   ```python
   if not config.extract_text:
       for txt_file in final_dir.glob("*.txt"):
           txt_file.unlink(missing_ok=True)
   ```
  </action>
  <verify>
Run `ruff check src/scholardoc_ocr/pipeline.py` — no errors.
Run `pytest tests/ -x -q` — existing tests pass (no regressions).
Manually verify: `grep -n "json.dumps\|extract_text\|\.txt.*unlink" src/scholardoc_ocr/pipeline.py` shows all three additions.
  </verify>
  <done>PipelineConfig has extract_text field. JSON metadata files are written after all processing. Text files are cleaned up unless extract_text=True.</done>
</task>

<task type="auto">
  <name>Task 2: --extract-text and --json CLI flags</name>
  <files>src/scholardoc_ocr/cli.py</files>
  <action>
1. Add `--extract-text` flag to argparse:
   ```python
   parser.add_argument("--extract-text", action="store_true",
       help="Write post-processed .txt file alongside output PDF")
   ```

2. Add `--json` flag to argparse:
   ```python
   parser.add_argument("--json", action="store_true", dest="json_output",
       help="Output structured JSON results to stdout (suppresses progress display)")
   ```
   Use `dest="json_output"` to avoid shadowing the `json` module.

3. Map `--extract-text` to `PipelineConfig(extract_text=args.extract_text)` in config construction.

4. When `--json` is set:
   - Use `LoggingCallback` (or a null callback) instead of `RichCallback` to suppress Rich progress bars. Do NOT print any Rich output.
   - After `run_pipeline()` returns `BatchResult`, print `batch.to_json(include_text=args.extract_text)` to stdout.
   - Set exit code: `sys.exit(0 if batch.error_count == 0 else 1)`.
   - Skip the existing Rich summary table.

5. When `--json` is NOT set, behavior is unchanged (Rich progress + summary table as before).
  </action>
  <verify>
Run `ruff check src/scholardoc_ocr/cli.py` — no errors.
Run `ocr --help` and confirm `--extract-text` and `--json` appear in output.
Run `pytest tests/ -x -q` — no regressions.
  </verify>
  <done>`ocr --extract-text` enables .txt persistence. `ocr --json` outputs JSON to stdout with no Rich output. Both flags appear in --help.</done>
</task>

</tasks>

<verification>
1. `ruff check src/` passes
2. `pytest tests/ -x -q` passes (no regressions)
3. `ocr --help` shows both new flags
4. `grep -c "json.dumps" src/scholardoc_ocr/pipeline.py` returns >= 1
5. `grep -c "extract.text\|json_output" src/scholardoc_ocr/cli.py` returns >= 2
</verification>

<success_criteria>
- JSON metadata file writing is implemented in pipeline.py after Phase 2
- --extract-text controls .txt file persistence
- --json outputs BatchResult.to_json() to stdout with Rich suppressed
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-output-and-mcp/10-01-SUMMARY.md`
</output>
